    <!doctype html>
    <html lang="ko"><head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width,initial-scale=1"/>
      <title>ìë£Œ | JOOLAB</title>
      <link rel="stylesheet" href="/assets/style.css"/>

    </head><body>
      <div class="nav">
        <div class="brand"><span>ğŸ“Š JOOLAB</span><span class="badge">Bigdata Clean</span></div>
        <div class="row" style="gap:8px">
          <div id="who" class="row" style="gap:8px"></div>
          <a class="btn" href="/bigdata.html">ìë£Œ</a>
          <a class="btn" href="/me.html">ë‚´ì •ë³´</a>
          <a class="btn" id="navAdmin" href="/admin.html">ê´€ë¦¬</a>
          <button class="btn" id="btnLogout">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
      <div class="container">
        <div id="toast" class="notice ok" style="display:none"></div>
        <div class="grid">
  <div class="card">
    <div class="h1">ìë£Œ(ë¹…ë°ì´í„°)</div>
    <p class="p">CSV ì—…ë¡œë“œ â†’ ì˜ˆì˜ê²Œ ë Œë” â†’ ê²Œì‹œê¸€ ë“±ë¡.</p>
    <div class="row" style="flex-wrap:wrap">
      <select id="category" class="input" style="max-width:220px">
        <option value="strong">ê°•í•œì¢…ëª©</option>
        <option value="accum">ë§¤ì§‘ì¢…ëª©</option>
        <option value="suspicious">ìˆ˜ìƒí•´ìˆ˜ìƒí•´(Top15)</option>
      </select>
      <select id="region" class="input" style="max-width:140px">
        <option value="KR">KR</option>
        <option value="US">US</option>
      </select>
      <input id="title" class="input" placeholder="ê²Œì‹œê¸€ ì œëª© (ì˜ˆ: ê°•í•œì¢…ëª© 260130)" style="min-width:260px;flex:1"/>
      <input id="file" class="input" type="file" accept=".csv,text/csv" style="max-width:320px"/>
      <button class="btn accent" id="btnPreview">ë¯¸ë¦¬ë³´ê¸°</button>
      <button class="btn primary" id="btnPublish">ê¸€ë¡œ ë“±ë¡</button>
    </div>
    <div class="small">ê´€ë¦¬ìë§Œ â€œê¸€ë¡œ ë“±ë¡â€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì¼ë°˜ íšŒì›ì€ ë¯¸ë¦¬ë³´ê¸°ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
  </div>
  <div id="preview"></div>
  <div class="card">
    <div class="h2">ê²Œì‹œê¸€ ëª©ë¡</div>
    <div class="row" style="flex-wrap:wrap"><button class="btn" id="btnReload">ìƒˆë¡œê³ ì¹¨</button></div>
    <div id="list"></div>
  </div>
</div>
<script>
let lastHtml="", lastMeta=null;
async function ensureAccess(){
  await JOOLAB.api("/api/access/check");
}
function nowLabel(){ return new Date().toLocaleString("ko-KR"); }

async function loadList(){
  const d=await JOOLAB.api("/api/posts/list");
  const items=d.items||[];
  if(items.length===0){ $("#list").innerHTML=`<div class="notice warn">ê²Œì‹œê¸€ ì—†ìŒ</div>`; return; }
  const headers=["created_at","category","region","title","open"];
  const rows=items.map(x=>({created_at:x.created_at,category:x.category,region:x.region,title:x.title,open:"ë³´ê¸°"}));
  const html=JOOLAB.buildTableHtml(headers, rows, {category:"posts",region:"-",generatedAt:nowLabel()});
  $("#list").innerHTML=html;
  const trs=$$("#list tbody tr");
  trs.forEach((tr,idx)=>{
    tr.lastElementChild.innerHTML=`<a class="btn" href="/post.html?id=${encodeURIComponent(items[idx].id)}">ì—´ê¸°</a>`;
  });
}

async function buildPreviewFromFile(){
  const f=$("#file").files[0];
  if(!f) throw new Error("CSVë¥¼ ì„ íƒí•˜ì‹­ì‹œì˜¤");
  const text=await f.text();
  const parsed=JOOLAB.parseCSV(text);
  if(parsed.data.length===0) throw new Error("CSV ë°ì´í„°ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤");
  const meta={category:$("#category").value,region:$("#region").value,generatedAt:nowLabel(),note:""};
  let rows=parsed.data;
  if(meta.category==="suspicious"){
    const s=JOOLAB.sortSuspicious(parsed.headers, parsed.data);
    rows=s.rows; meta.note=s.note;
  }
  lastMeta=meta;
  lastHtml=JOOLAB.buildTableHtml(parsed.headers, rows, meta);
  $("#preview").innerHTML=lastHtml;
}

$("#btnPreview").addEventListener("click", async ()=>{
  try{ await ensureAccess(); await buildPreviewFromFile(); JOOLAB.toast("ë¯¸ë¦¬ë³´ê¸° ìƒì„± ì™„ë£Œ","ok"); }
  catch(e){ if(e.message.includes("BLOCKED")||e.message.includes("NO_PAYMENT")) location.href="/gate.html"; else JOOLAB.toast(e.message,"danger"); }
});
$("#btnPublish").addEventListener("click", async ()=>{
  try{
    await ensureAccess();
    if(!lastHtml) await buildPreviewFromFile();
    const title=$("#title").value.trim() || `${$("#category").selectedOptions[0].text} ${new Date().toLocaleDateString("ko-KR")}`;
    await JOOLAB.api("/api/posts/create",{method:"POST",body:JSON.stringify({title,category:lastMeta.category,region:lastMeta.region,html:lastHtml})});
    JOOLAB.toast("ê²Œì‹œê¸€ ë“±ë¡ ì™„ë£Œ","ok");
    await loadList();
  }catch(e){
    if(e.message.includes("ADMIN_ONLY")) JOOLAB.toast("ê´€ë¦¬ìë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤","danger");
    else if(e.message.includes("BLOCKED")||e.message.includes("NO_PAYMENT")) location.href="/gate.html";
    else JOOLAB.toast("ë“±ë¡ ì‹¤íŒ¨: "+e.message,"danger");
  }
});
$("#btnReload").addEventListener("click", async ()=>{ try{ await ensureAccess(); await loadList(); }catch(e){ location.href="/gate.html"; } });

(async ()=>{
  try{ await JOOLAB.api("/api/me"); }catch(_){ location.href="/login.html"; return; }
  try{ await ensureAccess(); await loadList(); }catch(e){ location.href="/gate.html"; }
})();
</script>
      </div>
      <div class="footer small">Â© JOOLAB | ì‹¬í”Œ ìš´ì˜í˜•</div>
      <script src="/assets/app.js"></script>
      <script>JOOLAB.bindAuthUI();</script>
    </body></html>
