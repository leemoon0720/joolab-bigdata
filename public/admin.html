    <!doctype html>
    <html lang="ko"><head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width,initial-scale=1"/>
      <title>ê´€ë¦¬ì | JOOLAB</title>
      <link rel="stylesheet" href="/assets/style.css"/>

    </head><body>
      <div class="nav">
        <div class="brand"><span>ğŸ“Š JOOLAB</span><span class="badge">Bigdata Clean</span></div>
        <div class="row" style="gap:8px">
          <div id="who" class="row" style="gap:8px"></div>
          <a class="btn" href="/bigdata.html">ìë£Œ</a>
          <a class="btn" href="/me.html">ë‚´ì •ë³´</a>
          <a class="btn" id="navAdmin" href="/admin.html">ê´€ë¦¬</a>
          <button class="btn" id="btnLogout">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
      <div class="container">
        <div id="toast" class="notice ok" style="display:none"></div>
        <div class="grid">
  <div class="card">
    <div class="h1">ê´€ë¦¬ì</div>
    <div class="row" style="flex-wrap:wrap">
      <button class="btn" data-tab="users">íšŒì›</button>
      <button class="btn" data-tab="unpaid">ë¯¸ë‚©ì(ìœ ì˜ˆ/ì°¨ë‹¨)</button>
      <button class="btn" data-tab="payments">ê²°ì œ</button>
      <button class="btn" data-tab="requests">ì…ê¸ˆí™•ì¸ìš”ì²­</button>
      <button class="btn" data-tab="posts">ê²Œì‹œê¸€</button>
    </div>
  </div>

  <div id="tabUsers" class="card"></div>
  <div id="tabUnpaid" class="card" style="display:none"></div>
  <div id="tabPayments" class="card" style="display:none"></div>
  <div id="tabRequests" class="card" style="display:none"></div>
  <div id="tabPosts" class="card" style="display:none"></div>
</div>

<script src="/assets/app.js"></script>
<script>
function showTab(name){
  ["Users","Unpaid","Payments","Requests","Posts"].forEach(x=>{
    const el=$("#tab"+x);
    if(!el) return;
    el.style.display = (x.toLowerCase()===name) ? "block" : "none";
  });
}
$$("[data-tab]").forEach(b=>b.addEventListener("click",()=>showTab(b.dataset.tab)));

async function mustAdmin(){
  const me=await JOOLAB.api("/api/me");
  if(me.user.role!=="admin") throw new Error("ADMIN_ONLY");
}
async function loadUsers(){
  const d=await JOOLAB.api("/api/admin/users");
  const items=d.items||[];

  const headers=["ì•„ì´ë””","ì´ë¦„","ë§¤ë‹¬ê²°ì œì¼","ìƒíƒœ","ìµœê·¼ê²°ì œì¼","ê²°ì œê¸ˆì•¡","ê²°ì œí™•ì¸","ê´€ë¦¬"];
  const rows=items.map(u=>{
    const st=u.access_status||"";
    let sTxt=st;
    if(st==="ACTIVE") sTxt="ì™„ë£Œ";
    else if(st==="GRACE") sTxt="ë¯¸ì™„ë£Œ(ìœ ì˜ˆ)";
    else if(st==="NO_PAYMENT") sTxt="ë¯¸ì™„ë£Œ";
    else if(st==="BLOCKED") sTxt="ì°¨ë‹¨";
    if(u.blocked) sTxt="ì°¨ë‹¨(ìˆ˜ë™)";
    const day = (u.last_paid_at && String(u.last_paid_at).match(/^\d{4}-\d{2}-(\d{2})$/)) ? u.last_paid_at.split("-")[2] : "";
    return {
      "ì•„ì´ë””": u.username,
      "ì´ë¦„": u.name||"",
      "ë§¤ë‹¬ê²°ì œì¼": day,
      "ìƒíƒœ": sTxt,
      "ìµœê·¼ê²°ì œì¼": u.last_payment_paid_at||"",
      "ê²°ì œê¸ˆì•¡": (u.last_payment_amount==null) ? "" : String(u.last_payment_amount),
      "ê²°ì œí™•ì¸": "",
      "ê´€ë¦¬": ""
    };
  });

  const html=JOOLAB.buildTableHtml(headers,rows,{
    category:"admin_users_all",
    region:"-",
    generatedAt:new Date().toLocaleString("ko-KR"),
    note:"í‘œì—ì„œ ê²°ì œì¼/ê¸ˆì•¡/ê²°ì œí™•ì¸ ìˆ˜ì • í›„ ì €ì¥í•˜ì‹­ì‹œì˜¤. (ìµœê·¼ ê²°ì œ 1ê±´ ê¸°ì¤€ìœ¼ë¡œ ìˆ˜ì •ë©ë‹ˆë‹¤)"
  });

  $("#tabUsers").innerHTML=`<div class="h2">íšŒì› í†µí•©</div>${html}
    <div class="notice" style="margin-top:12px">
      <div class="h2">íšŒì› ì¼ê´„ ë“±ë¡(CSV)</div>
      <div class="small">ì—‘ì…€ì—ì„œ CSVë¡œ ì €ì¥ í›„ ì—…ë¡œë“œí•˜ì‹­ì‹œì˜¤. ì»¬ëŸ¼ ì˜ˆ: ì•„ì´ë””/ì´ë¦„/ë‹‰ë„¤ì„/ì´ë©”ì¼</div>
      <div class="row" style="flex-wrap:wrap; margin-top:8px">
        <input class="input" type="file" id="uBulkFile" accept=".csv"/>
        <button class="btn primary" id="uBulkRun">ì¼ê´„ ë“±ë¡</button>
        <div class="small" id="uBulkHint" style="margin-left:auto"></div>
      </div>
    </div>`;

  function todayYMD(){
    const d=new Date();
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }

  // bulk seed
  $("#uBulkRun").addEventListener("click", async ()=>{
    try{
      const f=$("#uBulkFile").files[0];
      if(!f) throw new Error("CSV íŒŒì¼ ì„ íƒ");
      const text=await f.text();
      const parsed=JOOLAB.parseCSV(text);
      const rows=parsed.data||[];
      const items=rows.map(r=>{
        const username=(r.username||r.USERNAME||r.ì•„ì´ë””||r.id||r.ID||"").trim();
        const name=(r.name||r.NAME||r.ì´ë¦„||"").trim();
        const nick=(r.payer_name||r.PAYER_NAME||r.ë‹‰ë„¤ì„||r.nickname||r.NICKNAME||"").trim();
        const email=(r.email||r.EMAIL||r.ì´ë©”ì¼||"").trim();
        const payer_name = nick || email || "";
        return { username, name, payer_name, password: username };
      }).filter(x=>x.username);
      if(items.length===0) throw new Error("CSV ë°ì´í„° ì—†ìŒ");
      const res=await JOOLAB.api("/api/admin/users/bulk_seed",{method:"POST",body:JSON.stringify({items})});
      $("#uBulkHint").textContent=`ì™„ë£Œ: ${res.inserted}ëª… | ìŠ¤í‚µ:${res.skipped}ëª… | ëˆ„ë½:${(res.missing||[]).length}`;
      JOOLAB.toast("íšŒì› ì¼ê´„ ë“±ë¡ ì™„ë£Œ","ok");
      await loadAll();
    }catch(e){ JOOLAB.toast("ì¼ê´„ ë“±ë¡ ì‹¤íŒ¨: "+e.message,"danger"); }
  });

  // inline payment controls + user ops
  const trs=$$("#tabUsers tbody tr");
  trs.forEach((tr,idx)=>{
    const u=items[idx];
    const tds=tr.querySelectorAll("td");
    // columns: 0ì•„ì´ë”” 1ì´ë¦„ 2ë§¤ë‹¬ê²°ì œì¼ 3ìƒíƒœ 4ìµœê·¼ê²°ì œì¼ 5ê²°ì œê¸ˆì•¡ 6ê²°ì œí™•ì¸ 7ê´€ë¦¬
    const defaultPaidAt = (u.last_payment_paid_at && /^\d{4}-\d{2}-\d{2}$/.test(String(u.last_payment_paid_at))) ? u.last_payment_paid_at : todayYMD();
    const defaultAmount = (u.last_payment_amount==null) ? "" : String(u.last_payment_amount);

    // ìµœê·¼ê²°ì œì¼ input
    tds[4].innerHTML = `<input class="input" data-k="paid_at" type="date" value="${defaultPaidAt}" style="padding:8px;border-radius:10px;min-width:140px"/>`;
    // ê¸ˆì•¡ input
    tds[5].innerHTML = `<input class="input" data-k="amount" type="number" min="0" step="1000" value="${defaultAmount}" style="padding:8px;border-radius:10px;max-width:140px"/>`;
    // ê²°ì œí™•ì¸ checkbox
    const checked = (u.last_payment_status==="CONFIRMED");
    tds[6].innerHTML = `<label class="small" style="display:flex;align-items:center;gap:6px">
      <input data-k="confirm" type="checkbox" ${checked?"checked":""}/> CONFIRMED
    </label>`;

    // ê´€ë¦¬ buttons
    tds[7].innerHTML = `<div class="row" style="gap:6px;flex-wrap:wrap">
      <button class="btn accent" data-act="save">ì €ì¥</button>
      <button class="btn" data-act="add">ì¶”ê°€</button>
      <button class="btn danger" data-act="del" ${u.last_payment_id?"" :"disabled"}>ì‚­ì œ</button>
      <span class="badge">${u.last_payment_id?("pay#"+u.last_payment_id):"no-pay"}</span>
      <button class="btn" data-act="toggle">${u.blocked?"ì°¨ë‹¨í•´ì œ":"ì°¨ë‹¨"}</button>
      <button class="btn" data-act="reset">ë¹„ë²ˆë¦¬ì…‹</button>
    </div>`;

    const getVal = (k)=> tr.querySelector(`[data-k="${k}"]`);
    const btnSave = tr.querySelector('[data-act="save"]');
    const btnAdd = tr.querySelector('[data-act="add"]');
    const btnDel = tr.querySelector('[data-act="del"]');
    const btnToggle = tr.querySelector('[data-act="toggle"]');
    const btnReset = tr.querySelector('[data-act="reset"]');

    async function doSave(mode){
      const paid_at = getVal("paid_at").value;
      const amount = Number(getVal("amount").value||0);
      const confirm = getVal("confirm").checked;
      const status = confirm ? "CONFIRMED" : "PENDING";
      if(!paid_at) throw new Error("ê²°ì œì¼ í•„ìš”");
      if(mode==="update"){
        await JOOLAB.api("/api/admin/payments/update",{method:"POST",body:JSON.stringify({id:u.last_payment_id, paid_at, amount, status, memo:""})});
      }else{
        await JOOLAB.api("/api/admin/payments/create",{method:"POST",body:JSON.stringify({username:u.username, paid_at, amount, status, memo:""})});
      }
    }

    btnSave.addEventListener("click", async ()=>{
      try{
        if(!u.last_payment_id) throw new Error("ìµœê·¼ ê²°ì œë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. 'ì¶”ê°€'ë¥¼ ë¨¼ì € ëˆ„ë¥´ì‹­ì‹œì˜¤");
        await doSave("update");
        JOOLAB.toast("ì €ì¥ ì™„ë£Œ","ok");
        await loadAll();
      }catch(e){ JOOLAB.toast("ì €ì¥ ì‹¤íŒ¨: "+e.message,"danger"); }
    });

    btnAdd.addEventListener("click", async ()=>{
      try{
        await doSave("create");
        JOOLAB.toast("ì¶”ê°€ ì™„ë£Œ","ok");
        await loadAll();
      }catch(e){ JOOLAB.toast("ì¶”ê°€ ì‹¤íŒ¨: "+e.message,"danger"); }
    });

    btnDel.addEventListener("click", async ()=>{
      try{
        if(!u.last_payment_id) return;
        if(!confirm("ìµœê·¼ ê²°ì œ 1ê±´ì„ ì‚­ì œí•©ë‹ˆê¹Œ?")) return;
        await JOOLAB.api("/api/admin/payments/delete",{method:"POST",body:JSON.stringify({id:u.last_payment_id})});
        JOOLAB.toast("ì‚­ì œ ì™„ë£Œ","ok");
        await loadAll();
      }catch(e){ JOOLAB.toast("ì‚­ì œ ì‹¤íŒ¨: "+e.message,"danger"); }
    });

    btnToggle.addEventListener("click", async ()=>{
      try{
        await JOOLAB.api("/api/admin/users/block",{method:"POST",body:JSON.stringify({user_id:u.id,blocked:!u.blocked})});
        JOOLAB.toast("ë°˜ì˜ ì™„ë£Œ","ok"); await loadAll();
      }catch(e){ JOOLAB.toast("ì‹¤íŒ¨: "+e.message,"danger"); }
    });

    btnReset.addEventListener("click", async ()=>{
      try{
        const np=prompt("ìƒˆ ë¹„ë°€ë²ˆí˜¸(ë¹„ìš°ë©´ usernameê³¼ ë™ì¼)") || u.username;
        await JOOLAB.api("/api/admin/users/reset_password",{method:"POST",body:JSON.stringify({user_id:u.id,new_password:np})});
        JOOLAB.toast("ë¹„ë²ˆ ë³€ê²½ ì™„ë£Œ","ok");
      }catch(e){ JOOLAB.toast("ì‹¤íŒ¨: "+e.message,"danger"); }
    });
  });
}

async function loadUnpaid(){
  const d=await JOOLAB.api("/api/admin/unpaid");
  const grace=d.grace||[], blocked=d.blocked||[];
  const sec=(title, items)=>{
    if(items.length===0) return `<div class="notice ok">${title}: 0ëª…</div>`;
    const headers=["username","name","last_paid_at","next_bill_at","grace_until","status"];
    const rows=items.map(x=>({username:x.username,name:x.name||"",last_paid_at:x.last_paid_at||"",next_bill_at:(x.next_bill_at||x.active_until||""),grace_until:x.grace_until||"",status:x.access_status}));
    return `<div class="h2">${title}</div>`+JOOLAB.buildTableHtml(headers,rows,{category:title,region:"-",generatedAt:new Date().toLocaleString("ko-KR")});
  };
  $("#tabUnpaid").innerHTML=sec("ìœ ì˜ˆ(GRACE)",grace)+"<hr/>"+sec("ì°¨ë‹¨(BLOCKED)",blocked);
}
async function loadPayments(){
  $("#tabPayments").innerHTML=`<div class="h2">ê²°ì œ</div>
    <div class="row" style="flex-wrap:wrap">
      <input class="input" id="pUser" placeholder="username"/>
      <input class="input" id="pAmount" placeholder="ê¸ˆì•¡(ìˆ«ì)" style="max-width:160px"/>
      <input class="input" id="pDate" placeholder="ê²°ì œì¼ YYYY-MM-DD" style="max-width:220px"/>
      <select class="input" id="pStatus" style="max-width:200px">
        <option value="CONFIRMED">CONFIRMED</option>
        <option value="PENDING">PENDING</option>
        <option value="CANCELED">CANCELED</option>
      </select>
      <input class="input" id="pMemo" placeholder="ë©”ëª¨" style="min-width:220px;flex:1"/>
      <button class="btn primary" id="pAdd">ì¶”ê°€</button>
    </div>
    <div class="notice" style="margin-top:12px">
  <div class="h2">ì›”ê²°ì œ ì¼ê´„ ë“±ë¡(CSV)</div>
  <div class="small">CSV í—¤ë”: username,paid_at (ì˜ˆ: kim23pk,2026-01-11)</div>
  <div class="row" style="flex-wrap:wrap">
    <input class="input" id="pBulkFile" type="file" accept=".csv,text/csv" style="max-width:320px"/>
    <button class="btn accent" id="pBulkRun">ì¼ê´„ ë“±ë¡</button>
  </div>
  <div class="small" id="pBulkHint"></div>
</div>
<div id="pList" style="margin-top:12px"></div>`;
  $("#pAdd").addEventListener("click", async ()=>{
    const username=$("#pUser").value.trim();
    const amount=Number(String($("#pAmount").value).replace(/[^0-9]/g,""));
    const paid_at=$("#pDate").value.trim();
    const status=$("#pStatus").value;
    const memo=$("#pMemo").value.trim();
    await JOOLAB.api("/api/admin/payments/create",{method:"POST",body:JSON.stringify({username,amount,paid_at,status,memo})});
    JOOLAB.toast("ì¶”ê°€ ì™„ë£Œ","ok"); await loadPaymentsList();
  });
  $("#pBulkRun").addEventListener("click", async ()=>{
    try{
      const f=$("#pBulkFile").files[0];
      if(!f) throw new Error("CSV íŒŒì¼ ì„ íƒ");
      const text=await f.text();
      const parsed=JOOLAB.parseCSV(text);
      const rows=parsed.data||[];
      const items=rows.map(r=>({username:(r.username||r.USERNAME||r.Username||"").trim(),paid_at:(r.paid_at||r.PAID_AT||r.PaidAt||"").trim()})).filter(x=>x.username&&x.paid_at);
      if(items.length===0) throw new Error("CSV ë°ì´í„° ì—†ìŒ");
      const res=await JOOLAB.api("/api/admin/payments/bulk_seed",{method:"POST",body:JSON.stringify({items})});
      $("#pBulkHint").textContent=`ì™„ë£Œ: ${res.inserted}ê±´ | ëˆ„ë½:${(res.missing||[]).length} | ìŠ¤í‚µ:${(res.skipped||[]).length}`;
      JOOLAB.toast("ì¼ê´„ ë“±ë¡ ì™„ë£Œ","ok");
      await loadPaymentsList();
    }catch(e){ JOOLAB.toast("ì¼ê´„ ë“±ë¡ ì‹¤íŒ¨: "+e.message,"danger"); }
  });
  await loadPaymentsList();
}
async function loadPaymentsList(){
  const d=await JOOLAB.api("/api/admin/payments/list");
  const items=d.items||[];
  const headers=["id","username","paid_at","amount","status","memo","actions"];
  const rows=items.map(x=>({id:x.id,username:x.username,paid_at:x.paid_at,amount:JOOLAB.fmt(x.amount),status:x.status,memo:x.memo||"",actions:""}));
  $("#pList").innerHTML=JOOLAB.buildTableHtml(headers,rows,{category:"payments",region:"-",generatedAt:new Date().toLocaleString("ko-KR")});
  const trs=$$("#pList tbody tr");
  trs.forEach((tr,idx)=>{
    const it=items[idx];
    tr.lastElementChild.innerHTML=`<button class="btn danger">ì‚­ì œ</button>`;
    tr.querySelector("button").addEventListener("click", async ()=>{
      if(!confirm("ì‚­ì œí•©ë‹ˆê¹Œ?")) return;
      await JOOLAB.api("/api/admin/payments/delete",{method:"POST",body:JSON.stringify({id:it.id})});
      JOOLAB.toast("ì‚­ì œ ì™„ë£Œ","ok"); await loadPaymentsList();
    });
  });
}
async function loadRequests(){
  const d=await JOOLAB.api("/api/admin/requests/list");
  const items=d.items||[];
  if(items.length===0){ $("#tabRequests").innerHTML=`<div class="h2">ì…ê¸ˆí™•ì¸ìš”ì²­</div><div class="notice ok">ì—†ìŒ</div>`; return; }
  const headers=["id","username","amount","created_at","status","actions"];
  const rows=items.map(x=>({id:x.id,username:x.username,amount:x.amount?JOOLAB.fmt(x.amount):"",created_at:x.created_at,status:x.status,actions:""}));
  $("#tabRequests").innerHTML=`<div class="h2">ì…ê¸ˆí™•ì¸ìš”ì²­</div>`+JOOLAB.buildTableHtml(headers,rows,{category:"requests",region:"-",generatedAt:new Date().toLocaleString("ko-KR")});
  const trs=$$("#tabRequests tbody tr");
  trs.forEach((tr,idx)=>{
    const it=items[idx];
    tr.lastElementChild.innerHTML=`<div class="row" style="flex-wrap:wrap">
      <button class="btn accent">ìŠ¹ì¸</button><button class="btn danger">ë°˜ë ¤</button></div>`;
    const [a,b]=tr.lastElementChild.querySelectorAll("button");
    a.addEventListener("click", async ()=>{
      const paid_at=prompt("ê²°ì œì¼ YYYY-MM-DD (ë¹„ìš°ë©´ ì˜¤ëŠ˜)","");
      const amount=prompt("ê¸ˆì•¡(ë¹„ìš°ë©´ ìš”ì²­ê¸ˆì•¡/ì—†ìœ¼ë©´ 0)","");
      await JOOLAB.api("/api/admin/requests/approve",{method:"POST",body:JSON.stringify({id:it.id,paid_at:paid_at||null,amount:amount?Number(String(amount).replace(/[^0-9]/g,"")):null})});
      JOOLAB.toast("ìŠ¹ì¸ ì™„ë£Œ","ok"); await loadAll();
    });
    b.addEventListener("click", async ()=>{
      await JOOLAB.api("/api/admin/requests/reject",{method:"POST",body:JSON.stringify({id:it.id})});
      JOOLAB.toast("ë°˜ë ¤ ì™„ë£Œ","ok"); await loadAll();
    });
  });
}
async function loadPosts(){
  const d=await JOOLAB.api("/api/posts/list");
  const items=d.items||[];
  if(items.length===0){ $("#tabPosts").innerHTML=`<div class="h2">ê²Œì‹œê¸€</div><div class="notice ok">ì—†ìŒ</div>`; return; }
  const headers=["id","created_at","category","region","title","actions"];
  const rows=items.map(x=>({id:x.id,created_at:x.created_at,category:x.category,region:x.region,title:x.title,actions:""}));
  $("#tabPosts").innerHTML=`<div class="h2">ê²Œì‹œê¸€</div>`+JOOLAB.buildTableHtml(headers,rows,{category:"posts",region:"-",generatedAt:new Date().toLocaleString("ko-KR")});
  const trs=$$("#tabPosts tbody tr");
  trs.forEach((tr,idx)=>{
    const it=items[idx];
    tr.lastElementChild.innerHTML=`<div class="row" style="flex-wrap:wrap">
      <a class="btn" href="/post.html?id=${encodeURIComponent(it.id)}" target="_blank">ì—´ê¸°</a>
      <button class="btn danger">ì‚­ì œ</button></div>`;
    tr.lastElementChild.querySelector("button").addEventListener("click", async ()=>{
      if(!confirm("ì‚­ì œí•©ë‹ˆê¹Œ?")) return;
      await JOOLAB.api("/api/admin/posts/delete",{method:"POST",body:JSON.stringify({id:it.id})});
      JOOLAB.toast("ì‚­ì œ ì™„ë£Œ","ok"); await loadAll();
    });
  });
}
async function loadAll(){
  await loadUsers(); await loadUnpaid(); await loadRequests(); await loadPosts();
  if($("#tabPayments").style.display!=="none") await loadPayments();
}
(async ()=>{
  try{ await mustAdmin(); await loadAll(); }
  catch(e){ location.href="/bigdata.html"; }
})();
</script>
      </div>
      <div class="footer small">Â© JOOLAB | ì‹¬í”Œ ìš´ì˜í˜•</div>
      <script>JOOLAB.bindAuthUI();</script>
    </body></html>
