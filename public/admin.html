    <!doctype html>
    <html lang="ko"><head>
      <meta charset="utf-8"/>
      <meta name="viewport" content="width=device-width,initial-scale=1"/>
      <title>ê´€ë¦¬ì | JOOLAB</title>
      <link rel="stylesheet" href="/assets/style.css"/>

    </head><body>
      <div class="nav">
        <div class="brand"><span>ğŸ“Š JOOLAB</span><span class="badge">Bigdata Clean</span></div>
        <div class="row" style="gap:8px">
          <div id="who" class="row" style="gap:8px"></div>
          <a class="btn" href="/bigdata.html">ìë£Œ</a>
          <a class="btn" href="/me.html">ë‚´ì •ë³´</a>
          <a class="btn" id="navAdmin" href="/admin.html">ê´€ë¦¬</a>
          <button class="btn" id="btnLogout">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
      <div class="container">
        <div id="toast" class="notice ok" style="display:none"></div>
        <div class="grid">
  <div class="card">
    <div class="h1">ê´€ë¦¬ì</div>
    <div class="row" style="flex-wrap:wrap">
      <button class="btn" data-tab="users">íšŒì›</button>
      <button class="btn" data-tab="unpaid">ë¯¸ë‚©ì(ìœ ì˜ˆ/ì°¨ë‹¨)</button>
      <button class="btn" data-tab="payments">ê²°ì œ</button>
      <button class="btn" data-tab="requests">ì…ê¸ˆí™•ì¸ìš”ì²­</button>
      <button class="btn" data-tab="posts">ê²Œì‹œê¸€</button>
    </div>
  </div>

  <div id="tabUsers" class="card"></div>
  <div id="tabUnpaid" class="card" style="display:none"></div>
  <div id="tabPayments" class="card" style="display:none"></div>
  <div id="tabRequests" class="card" style="display:none"></div>
  <div id="tabPosts" class="card" style="display:none"></div>
</div>

<script>
async function showTab(name){
  ["Users","Unpaid","Payments","Requests","Posts"].forEach(x=>{
    const el=$("#tab"+x);
    if(!el) return;
    el.style.display = (x.toLowerCase()===name) ? "block" : "none";
  });
  try{
    if(name==="users") await loadUsers();
    else if(name==="unpaid") await loadUnpaid();
    else if(name==="payments") await loadPayments();
    else if(name==="requests") await loadRequests();
    else if(name==="posts") await loadPosts();
  }catch(e){ JOOLAB.toast(e.message,"danger"); }
}
$$('[data-tab]').forEach(b=>b.addEventListener('click',()=>showTab(b.dataset.tab)));

async function mustAdmin(){
  const me=await JOOLAB.api("/api/me");
  if(me.user.role!=="admin") throw new Error("ADMIN_ONLY");
}
async function loadUsers(){
  const d=await JOOLAB.api("/api/admin/users");
  const items=d.items||[];
  const headers=["id","username","name","payer_name","role","blocked","last_paid_at","next_bill_at","grace_until","status","actions"];
  const rows=items.map(x=>({
    id:x.id,
    username:x.username,
    name:x.name||"",
    payer_name:x.payer_name||"",
    role:x.role||"",
    blocked:x.blocked?"Y":"N",
    last_paid_at:x.last_paid_at||"",
    next_bill_at:x.next_bill_at||"",
    grace_until:x.grace_until||"",
    status:x.access_status||"",
    actions:""
  }));
  const html=JOOLAB.buildTableHtml(headers,rows,{category:"admin/users",region:"-",generatedAt:new Date().toLocaleString("ko-KR")});

  $("#tabUsers").innerHTML=`<div class="h2">íšŒì›</div>

<div class="card" style="margin:10px 0">
  <div class="h2">íšŒì› ì¶”ê°€</div>
  <div class="row" style="gap:8px;flex-wrap:wrap">
    <input class="input" id="nuUser" placeholder="username" style="max-width:220px"/>
    <input class="input" id="nuName" placeholder="name" style="max-width:220px"/>
    <input class="input" id="nuPayer" placeholder="payer_name" style="max-width:220px"/>
    <select class="input" id="nuRole" style="max-width:160px">
      <option value="customer">customer</option>
      <option value="admin">admin</option>
    </select>
    <input class="input" id="nuPass" placeholder="password(ì„ íƒ)" style="max-width:220px"/>
    <button class="btn primary" id="btnAddUser">ì¶”ê°€</button>
  </div>
  <div class="small" style="margin-top:6px">password ë¹„ìš°ë©´ ê¸°ë³¸ê°’: username</div>
</div>

<div class="card" style="margin:10px 0">
  <div class="h2">íšŒì› CSV ì¼ê´„ ë“±ë¡</div>
  <div class="row" style="gap:8px;flex-wrap:wrap">
    <input type="file" id="usersCsv" accept=".csv" />
    <button class="btn" id="btnBulkUsers">CSV ë“±ë¡</button>
    <button class="btn" id="btnResetAllPw">ì „ì²´ ë¹„ë²ˆ=ì•„ì´ë”” ë¦¬ì…‹</button>
  </div>
  <div class="small" style="margin-top:6px">CSV ì»¬ëŸ¼: username,name,payer_name (í—¤ë” 1í–‰)</div>
</div>
${html}`;

  // íšŒì› ì¶”ê°€
  $("#btnAddUser")?.addEventListener("click", async ()=>{
    try{
      const username=$("#nuUser").value.trim();
      const name=$("#nuName").value.trim();
      const payer_name=$("#nuPayer").value.trim();
      const role=$("#nuRole").value;
      const password=$("#nuPass").value;
      if(!username) return JOOLAB.toast("username í•„ìš”","danger");
      await JOOLAB.api("/api/admin/users/create",{method:"POST",body:JSON.stringify({username,name,payer_name,role,password:password?password:null})});
      JOOLAB.toast("ì¶”ê°€ ì™„ë£Œ","ok");
      $("#nuUser").value=""; $("#nuName").value=""; $("#nuPayer").value=""; $("#nuPass").value="";
      await loadUsers();
    }catch(e){ JOOLAB.toast(e.message,"danger"); }
  });

  // CSV ì¼ê´„ë“±ë¡
  const file=$("#usersCsv");
  $("#btnBulkUsers")?.addEventListener("click", async ()=>{
    try{
      if(!file || !file.files || !file.files[0]) return JOOLAB.toast("CSV íŒŒì¼ì„ ì„ íƒí•˜ì‹­ì‹œì˜¤","danger");
      const text=await file.files[0].text();
      const parsed=JOOLAB.parseCSV(text);
      const data=parsed.data||[];
      if(!data.length) return JOOLAB.toast("CSV ë°ì´í„°ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤","danger");
      const users=data.map(r=>({
        username:String(r.username||r.USERNAME||r.user||r.id||"").trim(),
        name:String(r.name||r.NAME||"").trim(),
        payer_name:String(r.payer_name||r.PAYER_NAME||r.payer||"").trim()
      })).filter(u=>u.username);
      if(!users.length) return JOOLAB.toast("username ì»¬ëŸ¼ì´ í•„ìš”í•©ë‹ˆë‹¤","danger");
      const res=await JOOLAB.api("/api/admin/users/bulk_seed",{method:"POST",body:JSON.stringify({users})});
      JOOLAB.toast(`ë“±ë¡ ì™„ë£Œ: ${res.created} / ìŠ¤í‚µ: ${res.skipped}`,"ok");
      await loadUsers();
    }catch(e){ JOOLAB.toast(e.message,"danger"); }
  });

  // ì „ì²´ ë¹„ë²ˆ ë¦¬ì…‹
  $("#btnResetAllPw")?.addEventListener("click", async ()=>{
    try{
      if(!confirm("ì „ì²´ íšŒì› ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•„ì´ë””ì™€ ë™ì¼í•˜ê²Œ ì¬ì„¤ì •í•©ë‹ˆê¹Œ?")) return;
      const r=await JOOLAB.api("/api/admin/users/reset_all_passwords_same",{method:"POST",body:"{}"});
      JOOLAB.toast(`ì™„ë£Œ: ${r.updated}ëª…`,"ok");
    }catch(e){ JOOLAB.toast(e.message,"danger"); }
  });

  // í–‰ ì•¡ì…˜
  const trs=$$("#tabUsers tbody tr");
  trs.forEach((tr,idx)=>{
    const u=items[idx];
    tr.lastElementChild.innerHTML=`<div class="row" style="flex-wrap:wrap">
      <button class="btn" data-act="edit">ìˆ˜ì •</button>
      <button class="btn danger" data-act="del">ì‚­ì œ</button>
      <button class="btn" data-act="toggle">${u.blocked?"ì°¨ë‹¨í•´ì œ":"ì°¨ë‹¨"}</button>
      <button class="btn" data-act="reset">ë¹„ë²ˆë¦¬ì…‹</button>
    </div>`;

    tr.querySelector('[data-act="toggle"]').addEventListener("click", async ()=>{
      await JOOLAB.api("/api/admin/users/block",{method:"POST",body:JSON.stringify({user_id:u.id,blocked:!u.blocked})});
      JOOLAB.toast("ë°˜ì˜ ì™„ë£Œ","ok"); await loadUsers();
    });

    tr.querySelector('[data-act="reset"]').addEventListener("click", async ()=>{
      const np=prompt("ìƒˆ ë¹„ë°€ë²ˆí˜¸(ë¹„ìš°ë©´ usernameê³¼ ë™ì¼)");
      await JOOLAB.api("/api/admin/users/reset_password",{method:"POST",body:JSON.stringify({user_id:u.id,new_password:np||u.username})});
      JOOLAB.toast("ë¹„ë²ˆ ë³€ê²½ ì™„ë£Œ","ok");
    });

    tr.querySelector('[data-act="edit"]').addEventListener("click", async ()=>{
      try{
        const name=prompt("name", u.name||"") ?? (u.name||"");
        const payer_name=prompt("payer_name", u.payer_name||"") ?? (u.payer_name||"");
        const role=prompt("role (admin/customer)", u.role||"customer") ?? (u.role||"customer");
        await JOOLAB.api("/api/admin/users/update",{method:"POST",body:JSON.stringify({user_id:u.id,name:String(name).trim(),payer_name:String(payer_name).trim(),role:String(role).trim()})});
        JOOLAB.toast("ìˆ˜ì • ì™„ë£Œ","ok"); await loadUsers();
      }catch(e){ JOOLAB.toast(e.message,"danger"); }
    });

    tr.querySelector('[data-act="del"]').addEventListener("click", async ()=>{
      try{
        if(u.role==="admin") return JOOLAB.toast("admin ì‚­ì œ ë¶ˆê°€","danger");
        if(!confirm(`ì‚­ì œí•©ë‹ˆê¹Œ? (username=${u.username})`)) return;
        await JOOLAB.api("/api/admin/users/delete",{method:"POST",body:JSON.stringify({user_id:u.id})});
        JOOLAB.toast("ì‚­ì œ ì™„ë£Œ","ok"); await loadUsers();
      }catch(e){ JOOLAB.toast(e.message,"danger"); }
    });
  });
}


async function loadUnpaid(){
  const d=await JOOLAB.api("/api/admin/unpaid");
  const grace=d.grace||[], blocked=d.blocked||[];
  const sec=(title, items)=>{
    if(items.length===0) return `<div class="notice ok">${title}: 0ëª…</div>`;
    const headers=["username","name","last_paid_at","next_bill_at","grace_until","status"];
    const rows=items.map(x=>({username:x.username,name:x.name||"",last_paid_at:x.last_paid_at||"",next_bill_at:(x.next_bill_at||x.active_until||""),grace_until:x.grace_until||"",status:x.access_status}));
    return `<div class="h2">${title}</div>`+JOOLAB.buildTableHtml(headers,rows,{category:title,region:"-",generatedAt:new Date().toLocaleString("ko-KR")});
  };
  $("#tabUnpaid").innerHTML=sec("ìœ ì˜ˆ(GRACE)",grace)+"<hr/>"+sec("ì°¨ë‹¨(BLOCKED)",blocked);
}
async function loadPayments(){
  const today=(()=>{ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; })();
  $("#tabPayments").innerHTML=`<div class="h2">ê²°ì œ</div>
    <div class="row" style="flex-wrap:wrap">
      <input class="input" id="pUser" placeholder="username"/>
      <input class="input" id="pAmount" placeholder="ê¸ˆì•¡(ìˆ«ì)" style="max-width:160px"/>
      <input class="input" id="pDate" placeholder="ê²°ì œì¼ YYYY-MM-DD (ë¹„ìš°ë©´ ì˜¤ëŠ˜)" style="max-width:260px"/>
      <select class="input" id="pStatus" style="max-width:200px">
        <option value="CONFIRMED">CONFIRMED</option>
        <option value="PENDING">PENDING</option>
        <option value="CANCELED">CANCELED</option>
      </select>
      <input class="input" id="pMemo" placeholder="ë©”ëª¨" style="min-width:220px;flex:1"/>
      <button class="btn primary" id="pAdd">ì¶”ê°€</button>
    </div>
    <div class="notice" style="margin-top:12px">
  <div class="h2">ì›”ê²°ì œ ì¼ê´„ ë“±ë¡(CSV)</div>
  <div class="small">CSV í—¤ë”: username,paid_at (ì˜ˆ: kim23pk,2026-01-11)</div>
  <div class="row" style="flex-wrap:wrap">
    <input class="input" id="pBulkFile" type="file" accept=".csv,text/csv" style="max-width:320px"/>
    <button class="btn accent" id="pBulkRun">ì¼ê´„ ë“±ë¡</button>
  </div>
  <div class="small" id="pBulkHint"></div>
</div>
<div id="pList" style="margin-top:12px"></div>`;

  $("#pAdd").addEventListener("click", async ()=>{
    try{
      const username=$("#pUser").value.trim();
      const amount=Number(String($("#pAmount").value).replace(/[^0-9]/g,""));
      const paid_at=$("#pDate").value.trim() || today;
      const status=$("#pStatus").value;
      const memo=$("#pMemo").value.trim();
      const r=await JOOLAB.api("/api/admin/payments/create",{method:"POST",body:JSON.stringify({username,amount,paid_at,status,memo})});
      if(r && r.skipped) JOOLAB.toast("ì¤‘ë³µì´ë¼ ìŠ¤í‚µí–ˆìŠµë‹ˆë‹¤","warn");
      else JOOLAB.toast("ì¶”ê°€ ì™„ë£Œ","ok");
      await loadPaymentsList();
    }catch(e){ JOOLAB.toast(e.message,"danger"); }
  });

  $("#pBulkRun").addEventListener("click", async ()=>{
    try{
      const f=$("#pBulkFile").files[0];
      if(!f) throw new Error("CSV íŒŒì¼ ì„ íƒ");
      const text=await f.text();
      const parsed=JOOLAB.parseCSV(text);
      const rows=parsed.data||[];
      const items=rows.map(r=>({
        username:String(r.username||r.USERNAME||r.Username||r.user||r.id||"").trim(),
        paid_at:String(r.paid_at||r.PAID_AT||r.PaidAt||"").trim()
      })).filter(x=>x.username&&x.paid_at);
      if(items.length===0) throw new Error("CSV ë°ì´í„° ì—†ìŒ");
      const res=await JOOLAB.api("/api/admin/payments/bulk_seed",{method:"POST",body:JSON.stringify({items})});
      $("#pBulkHint").textContent=`ì™„ë£Œ: ${res.inserted}ê±´ | ëˆ„ë½:${(res.missing||[]).length} | ìŠ¤í‚µ:${(res.skipped||[]).length}`;
      JOOLAB.toast("ì¼ê´„ ë“±ë¡ ì™„ë£Œ","ok");
      await loadPaymentsList();
    }catch(e){ JOOLAB.toast("ì¼ê´„ ë“±ë¡ ì‹¤íŒ¨: "+e.message,"danger"); }
  });

  await loadPaymentsList();
}

async function loadPaymentsList(){
  const d=await JOOLAB.api("/api/admin/payments/list");
  const items=d.items||[];
  const headers=["id","username","paid_at","amount","status","memo","actions"];
  const rows=items.map(x=>({id:x.id,username:x.username,paid_at:x.paid_at,amount:JOOLAB.fmt(x.amount),status:x.status,memo:x.memo||"",actions:""}));
  $("#pList").innerHTML=JOOLAB.buildTableHtml(headers,rows,{category:"payments",region:"-",generatedAt:new Date().toLocaleString("ko-KR")});
  const trs=$$("#pList tbody tr");
  trs.forEach((tr,idx)=>{
    const it=items[idx];
    tr.lastElementChild.innerHTML=`<div class="row" style="flex-wrap:wrap">
      <button class="btn" data-act="edit">ìˆ˜ì •</button>
      <button class="btn danger" data-act="del">ì‚­ì œ</button>
    </div>`;
    tr.querySelector('[data-act="edit"]').addEventListener("click", async ()=>{
      try{
        const paid_at=prompt("ê²°ì œì¼ YYYY-MM-DD", it.paid_at||"") || (it.paid_at||"");
        const amountRaw=prompt("ê¸ˆì•¡(ìˆ«ì)", String(it.amount??"")) || String(it.amount??"");
        const amount=Number(String(amountRaw).replace(/[^0-9]/g,""));
        const status=prompt("status (CONFIRMED/PENDING/CANCELED)", it.status||"CONFIRMED") || (it.status||"CONFIRMED");
        const memo=prompt("ë©”ëª¨", it.memo||"") || (it.memo||"");
        await JOOLAB.api("/api/admin/payments/update",{method:"POST",body:JSON.stringify({id:it.id,paid_at,amount,status,memo})});
        JOOLAB.toast("ìˆ˜ì • ì™„ë£Œ","ok");
        await loadPaymentsList();
      }catch(e){ JOOLAB.toast(e.message,"danger"); }
    });
    tr.querySelector('[data-act="del"]').addEventListener("click", async ()=>{
      try{
        if(!confirm("ì‚­ì œí•©ë‹ˆê¹Œ?")) return;
        await JOOLAB.api("/api/admin/payments/delete",{method:"POST",body:JSON.stringify({id:it.id})});
        JOOLAB.toast("ì‚­ì œ ì™„ë£Œ","ok");
        await loadPaymentsList();
      }catch(e){ JOOLAB.toast(e.message,"danger"); }
    });
  });
}

async function loadRequests(){
  const d=await JOOLAB.api("/api/admin/requests/list");
  const items=d.items||[];
  if(items.length===0){ $("#tabRequests").innerHTML=`<div class="h2">ì…ê¸ˆí™•ì¸ìš”ì²­</div><div class="notice ok">ì—†ìŒ</div>`; return; }
  const headers=["id","username","amount","created_at","status","actions"];
  const rows=items.map(x=>({id:x.id,username:x.username,amount:x.amount?JOOLAB.fmt(x.amount):"",created_at:x.created_at,status:x.status,actions:""}));
  $("#tabRequests").innerHTML=`<div class="h2">ì…ê¸ˆí™•ì¸ìš”ì²­</div>`+JOOLAB.buildTableHtml(headers,rows,{category:"requests",region:"-",generatedAt:new Date().toLocaleString("ko-KR")});
  const trs=$$("#tabRequests tbody tr");
  trs.forEach((tr,idx)=>{
    const it=items[idx];
    tr.lastElementChild.innerHTML=`<div class="row" style="flex-wrap:wrap">
      <button class="btn accent">ìŠ¹ì¸</button><button class="btn danger">ë°˜ë ¤</button></div>`;
    const [a,b]=tr.lastElementChild.querySelectorAll("button");
    a.addEventListener("click", async ()=>{
      const paid_at=prompt("ê²°ì œì¼ YYYY-MM-DD (ë¹„ìš°ë©´ ì˜¤ëŠ˜)","");
      const amount=prompt("ê¸ˆì•¡(ë¹„ìš°ë©´ ìš”ì²­ê¸ˆì•¡/ì—†ìœ¼ë©´ 0)","");
      await JOOLAB.api("/api/admin/requests/approve",{method:"POST",body:JSON.stringify({id:it.id,paid_at:paid_at||null,amount:amount?Number(String(amount).replace(/[^0-9]/g,"")):null})});
      JOOLAB.toast("ìŠ¹ì¸ ì™„ë£Œ","ok"); await loadAll();
    });
    b.addEventListener("click", async ()=>{
      await JOOLAB.api("/api/admin/requests/reject",{method:"POST",body:JSON.stringify({id:it.id})});
      JOOLAB.toast("ë°˜ë ¤ ì™„ë£Œ","ok"); await loadAll();
    });
  });
}
async function loadPosts(){
  const d=await JOOLAB.api("/api/posts/list");
  const items=d.items||[];
  if(items.length===0){ $("#tabPosts").innerHTML=`<div class="h2">ê²Œì‹œê¸€</div><div class="notice ok">ì—†ìŒ</div>`; return; }
  const headers=["id","created_at","category","region","title","actions"];
  const rows=items.map(x=>({id:x.id,created_at:x.created_at,category:x.category,region:x.region,title:x.title,actions:""}));
  $("#tabPosts").innerHTML=`<div class="h2">ê²Œì‹œê¸€</div>`+JOOLAB.buildTableHtml(headers,rows,{category:"posts",region:"-",generatedAt:new Date().toLocaleString("ko-KR")});
  const trs=$$("#tabPosts tbody tr");
  trs.forEach((tr,idx)=>{
    const it=items[idx];
    tr.lastElementChild.innerHTML=`<div class="row" style="flex-wrap:wrap">
      <a class="btn" href="/post.html?id=${encodeURIComponent(it.id)}" target="_blank">ì—´ê¸°</a>
      <button class="btn danger">ì‚­ì œ</button></div>`;
    tr.lastElementChild.querySelector("button").addEventListener("click", async ()=>{
      if(!confirm("ì‚­ì œí•©ë‹ˆê¹Œ?")) return;
      await JOOLAB.api("/api/admin/posts/delete",{method:"POST",body:JSON.stringify({id:it.id})});
      JOOLAB.toast("ì‚­ì œ ì™„ë£Œ","ok"); await loadAll();
    });
  });
}
async function loadAll(){
  await loadUsers(); await loadUnpaid(); await loadRequests(); await loadPosts();
  if($("#tabPayments").style.display!=="none") await loadPayments();
}
(async ()=>{
  try{ await mustAdmin(); await loadAll(); }
  catch(e){
  const box=document.createElement("div");
  box.style.maxWidth="520px"; box.style.margin="48px auto"; box.style.padding="20px";
  box.style.background="#fff"; box.style.border="1px solid #e2e8f0"; box.style.borderRadius="14px";
  box.innerHTML = `<div class="h2">ê´€ë¦¬ì ì „ìš©</div>
    <div class="small" style="margin-top:8px">ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ˆê±°ë‚˜ ê´€ë¦¬ì ê¶Œí•œì´ ì•„ë‹™ë‹ˆë‹¤.</div>
    <div class="row" style="margin-top:14px; gap:8px; flex-wrap:wrap">
      <a class="btn" href="/login.html">ë¡œê·¸ì¸ìœ¼ë¡œ ì´ë™</a>
      <a class="btn" href="/bigdata.html">ìë£Œì‹¤ë¡œ ì´ë™</a>
    </div>`;
  const main=document.querySelector(".container");
  if(main) main.innerHTML="";
  (main||document.body).appendChild(box);
}
})();
</script>
      </div>
      <div class="footer small">Â© JOOLAB | ì‹¬í”Œ ìš´ì˜í˜•</div>
      <script src="/assets/app.js"></script>
      <script>JOOLAB.bindAuthUI();</script>
    </body></html>
