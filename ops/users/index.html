<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>회원 생성 | 운영센터</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif; margin:20px; line-height:1.4;}
    input{padding:6px; width:320px; max-width:90vw;}
    button{padding:8px 12px; margin-top:8px;}
    table{border-collapse:collapse; width:100%; margin-top:10px;}
    th,td{border:1px solid #ddd; padding:8px; text-align:left;}
    th{background:#f5f5f5;}
    .row{margin:6px 0;}
    .msg{color:#333; font-size:13px; white-space:pre-wrap;}
  </style>
</head>
<body>
  <h1>운영센터 - 회원 생성/비밀번호 재설정</h1>
  <p id="who">확인중...</p>

  <hr />
  <h2>회원 생성</h2>
  <div class="row"><label>이메일 <input id="c_email" placeholder="user@example.com" /></label></div>
  <div class="row"><label>비밀번호(8자 이상) <input id="c_pass" type="password" placeholder="********" /></label></div>
  <div class="row"><label>이름 <input id="c_name" placeholder="홍길동" /></label></div>
  <div class="row"><label>닉네임 <input id="c_nick" placeholder="길동" /></label></div>
  <button id="btn_create">생성</button>
  <div class="msg" id="c_msg"></div>

  <hr />
  <h2>비밀번호 재설정</h2>
  <div class="row"><label>이메일 <input id="r_email" placeholder="user@example.com" /></label></div>
  <div class="row"><label>새 비밀번호(8자 이상) <input id="r_pass" type="password" placeholder="********" /></label></div>
  <button id="btn_reset">재설정</button>
  <div class="msg" id="r_msg"></div>

  <hr />
  <h2>가입 신청 목록</h2>
  <button id="btn_load">불러오기</button>
  <div class="msg" id="l_msg"></div>
  <table>
    <thead>
      <tr>
        <th>이메일</th>
        <th>이름</th>
        <th>전화</th>
        <th>메모</th>
        <th>생성일</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script>
    async function jget(url){
      const r = await fetch(url, { credentials: 'include' });
      return await r.json().catch(() => ({ ok: false }));
    }
    async function jpost(url, body){
      const r = await fetch(url, {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify(body || {}),
        credentials: 'include'
      });
      return await r.json().catch(() => ({ ok: false }));
    }

    (async () => {
      const me = await jget('/api/auth/me');
      if(!me.ok){
        document.getElementById('who').textContent = '로그인 필요 (/login/에서 관리자 로그인)';
        return;
      }
      const role = (me.user && me.user.role) ? me.user.role : 'user';
      document.getElementById('who').textContent = me.user.email + ' (' + role + ')';
      if(role !== 'admin'){
        alert('관리자만 사용할 수 있습니다.');
      }
    })();

    document.getElementById('btn_create').onclick = async () => {
      document.getElementById('c_msg').textContent = '처리중...';
      const res = await jpost('/api/admin/users/create', {
        email: document.getElementById('c_email').value,
        password: document.getElementById('c_pass').value,
        name: document.getElementById('c_name').value,
        nickname: document.getElementById('c_nick').value,
        role: 'user'
      });
      document.getElementById('c_msg').textContent = res.ok ? ('생성 완료: ' + res.email) : (res.message || '실패');
    };

    document.getElementById('btn_reset').onclick = async () => {
      document.getElementById('r_msg').textContent = '처리중...';
      const res = await jpost('/api/admin/users/reset_password', {
        email: document.getElementById('r_email').value,
        new_password: document.getElementById('r_pass').value
      });
      document.getElementById('r_msg').textContent = res.ok ? ('재설정 완료: ' + res.email) : (res.message || '실패');
    };

    document.getElementById('btn_load').onclick = async () => {
      document.getElementById('l_msg').textContent = '불러오는 중...';
      const res = await jget('/api/admin/signup/requests?limit=20');
      const tb = document.getElementById('tbody');
      tb.innerHTML = '';
      if(!res.ok){
        document.getElementById('l_msg').textContent = res.message || '불러오기 실패';
        return;
      }
      (res.items || []).forEach(it => {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td>' + (it.email||'') + '</td>'
          + '<td>' + (it.name||'') + '</td>'
          + '<td>' + (it.phone||'') + '</td>'
          + '<td>' + (it.memo||'') + '</td>'
          + '<td>' + (it.created_at||'') + '</td>';
        tb.appendChild(tr);
      });
      document.getElementById('l_msg').textContent = '총 ' + (res.items||[]).length + '건';
    };
  </script>
</body>
</html>
